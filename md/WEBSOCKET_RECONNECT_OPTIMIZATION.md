# WebSocket 自动重连优化方案

## 问题分析

### 原始问题
用户离开页面（切换标签页、最小化窗口等）后再回来时，需要手动刷新页面才能继续使用，这是因为 WebSocket 连接断开后没有自动重连机制。

### 问题原因
1. **缺少连接状态监听**：没有监听 WebSocket 的 `connect`、`disconnect`、`reconnect` 事件
2. **页面可见性处理不完整**：`visibilitychange` 事件只刷新文件列表，没有检查连接状态
3. **重连后状态不同步**：即使重连成功，也没有重新加入房间并同步文件列表
4. **缺少用户反馈**：用户无法知道当前连接状态

## 优化方案

### 1. WebSocket 连接配置优化

**配置自动重连参数**：
```javascript
const socket = io({
    reconnection: true,              // 启用自动重连
    reconnectionDelay: 1000,         // 初始重连延迟 1 秒
    reconnectionDelayMax: 5000,      // 最大重连延迟 5 秒
    reconnectionAttempts: Infinity,   // 无限重连尝试
    timeout: 20000                   // 连接超时 20 秒
});
```

### 2. 连接状态监听

**添加完整的事件监听**：
- `connect`: 连接成功时触发
- `disconnect`: 连接断开时触发
- `reconnect_attempt`: 重连尝试时触发
- `reconnect`: 重连成功时触发
- `reconnect_failed`: 重连失败时触发
- `connect_error`: 连接错误时触发

### 3. 页面可见性优化

**改进 `visibilitychange` 处理**：
- 页面重新可见时检查连接状态
- 如果断开则触发重连
- 如果已连接则同步房间状态

**添加网络状态监听**：
- `online`: 网络恢复时检查连接
- `offline`: 网络断开时显示提示

### 4. 房间状态同步

**重连后自动重新加入房间**：
- 检测到重连成功后自动调用 `join-room`
- 服务器返回房间状态（文件列表、用户数等）
- 客户端同步文件列表，避免重复添加

### 5. 连接状态指示器

**添加可视化连接状态**：
- 🟢 已连接
- 🟡 重连中
- 🔴 已断开

显示在用户数旁边，鼠标悬停显示详细状态。

## 实现细节

### 核心函数

1. **`setupSocketHandlers()`**: 设置所有 WebSocket 事件监听器
2. **`joinRoom()`**: 加入房间（带防重复逻辑）
3. **`checkAndReconnect()`**: 检查连接状态并重连
4. **`syncFilesFromServer()`**: 同步服务器文件列表
5. **`updateConnectionStatus()`**: 更新连接状态指示器

### 关键改进点

1. **防重复加入房间**：使用 `isRejoiningRoom` 标志防止重复调用
2. **智能文件同步**：检查 DOM 和内存中的文件，避免重复添加
3. **状态更新**：重连后更新文件状态，确保 UI 正确显示
4. **用户反馈**：通过 Toast 通知和状态指示器提供实时反馈

## 测试场景

### 场景 1: 切换标签页
1. 打开房间页面
2. 切换到其他标签页
3. 等待几秒后切回
4. **预期**：自动重连并同步状态，无需刷新

### 场景 2: 最小化窗口
1. 打开房间页面
2. 最小化浏览器窗口
3. 等待一段时间后恢复
4. **预期**：自动重连并同步状态

### 场景 3: 网络断开
1. 打开房间页面
2. 断开网络连接
3. 等待几秒后恢复网络
4. **预期**：自动检测网络恢复并重连

### 场景 4: 服务器重启
1. 打开房间页面
2. 重启服务器
3. 等待服务器恢复
4. **预期**：自动重连并重新加入房间

## 使用说明

### 用户视角
- 离开页面后再回来，系统会自动重连
- 连接状态通过状态指示器实时显示
- 重连过程中会显示提示信息
- 无需手动刷新页面

### 开发者视角
- 所有连接状态变化都有控制台日志
- 重连逻辑完全自动化，无需手动干预
- 文件同步逻辑智能处理重复情况

## 技术细节

### Socket.IO 重连机制
Socket.IO 内置了自动重连功能，但需要：
1. 正确配置重连参数
2. 监听重连事件
3. 重连后恢复应用状态

### 状态同步策略
1. **首次加入**：服务器发送完整房间状态
2. **重连后**：服务器再次发送完整状态
3. **客户端**：智能合并，避免重复

### 性能考虑
- 重连延迟递增，避免频繁请求
- 文件同步时检查 DOM，避免重复渲染
- 状态更新只更新变化的部分

## 后续优化建议

1. **离线缓存**：使用 Service Worker 缓存文件列表
2. **增量同步**：只同步变化的部分，而不是全量
3. **连接质量监控**：监控延迟和丢包率
4. **重连策略优化**：根据网络状况调整重连策略

## 更新日志

### 2024-01-XX
- ✅ 添加 WebSocket 自动重连机制
- ✅ 添加连接状态监听和指示器
- ✅ 优化页面可见性处理
- ✅ 实现房间状态自动同步
- ✅ 添加网络状态监听

